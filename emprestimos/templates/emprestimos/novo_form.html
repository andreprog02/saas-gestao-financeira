{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-cash-coin"></i> Novo Empréstimo
                    </h4>
                    <span class="badge bg-light text-primary">{{ cliente.nome_completo }}</span>
                </div>
                
                <div class="card-body">
                    {% if simulacao %}
                    <div class="alert alert-success border-success">
                        <h5 class="alert-heading"><i class="bi bi-check-circle-fill"></i> Simulação Realizada!</h5>
                        <hr>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <small class="text-muted">Valor da Parcela</small>
                                <h4 class="fw-bold text-success">R$ {{ simulacao.parcela_aplicada|floatformat:2 }}</h4>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Total a Pagar</small>
                                <h5>R$ {{ simulacao.total_contrato|floatformat:2 }}</h5>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Primeiro Vencimento</small>
                                <h5>{{ form.primeiro_vencimento.value }}</h5>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <form method="POST" autocomplete="off">
                        {% csrf_token %}
                        
                        {{ form.cliente_id }}

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.valor_emprestado.id_for_label }}" class="form-label fw-bold">Valor do Empréstimo</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_emprestado }}
                                </div>
                                <div class="text-danger small">{{ form.valor_emprestado.errors }}</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.qtd_parcelas.id_for_label }}" class="form-label fw-bold">Qtd. Parcelas</label>
                                {{ form.qtd_parcelas }}
                                <div class="text-danger small">{{ form.qtd_parcelas.errors }}</div>
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.taxa_juros_mensal.id_for_label }}" class="form-label fw-bold">Juros Mensal (%)</label>
                                <div class="input-group">
                                    {{ form.taxa_juros_mensal }}
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="text-danger small">{{ form.taxa_juros_mensal.errors }}</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.primeiro_vencimento.id_for_label }}" class="form-label fw-bold">Primeiro Vencimento</label>
                                {{ form.primeiro_vencimento }}
                                <div class="text-danger small">{{ form.primeiro_vencimento.errors }}</div>
                            </div>
                        </div>

                        <div class="card mb-4 border-warning bg-light">
                            <div class="card-header bg-warning text-dark fw-bold">
                                <i class="bi bi-wallet2"></i> Opções de Desembolso (Conta Corrente)
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="{{ form.saque_inicial.id_for_label }}" class="form-label fw-bold">
                                            Saque/Transferência Imediata (R$)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            {{ form.saque_inicial }}
                                        </div>
                                        <div class="form-text text-danger">
                                            <i class="bi bi-exclamation-triangle"></i> 
                                            <strong>Atenção:</strong> 
                                            Se você deixar <strong>R$ 0,00</strong>, o valor do empréstimo entra como crédito na conta virtual do cliente e <strong>não sai dinheiro do seu caixa</strong> agora.
                                            <br>
                                            Preencha este campo se você está entregando dinheiro em espécie ou fazendo PIX agora.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion mb-3" id="accordionOpcoes">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                        Configurações de Atraso (Multa e Mora)
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionOpcoes">
                                    <div class="accordion-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mt-4">
                                                    {{ form.tem_multa_atraso }}
                                                    <label class="form-check-label" for="{{ form.tem_multa_atraso.id_for_label }}">Cobrar Multa?</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Multa (%)</label>
                                                {{ form.multa_atraso_percent }}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Juros Mora (% a.m.)</label>
                                                {{ form.juros_mora_mensal_percent }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            {{ form.observacoes }}
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'emprestimos:novo_busca' %}" class="btn btn-outline-secondary me-md-2">Cancelar</a>
                            
                            <button type="submit" name="simular" value="1" class="btn btn-info text-white me-md-2">
                                <i class="bi bi-calculator"></i> Simular Parcelas
                            </button>
                            
                            {% if simulacao %}
                            <button type="submit" name="confirmar_cadastro" value="1" class="btn btn-success btn-lg">
                                <i class="bi bi-check-lg"></i> Confirmar e Gerar Contrato
                            </button>
                            {% endif %}
                        </div>

                    </form>
                </div>
            </div>
            
            {% if simulacao and simulacao.parcelas %}
            <div class="card mt-4 mb-5 border-info">
                <div class="card-header bg-info text-white">
                    Pré-visualização das Parcelas
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Vencimento</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in simulacao.parcelas %}
                            <tr>
                                <td>{{ p.numero }}</td>
                                <td>{{ p.vencimento|date:"d/m/Y" }}</td>
                                <td class="text-end">R$ {{ p.valor|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}