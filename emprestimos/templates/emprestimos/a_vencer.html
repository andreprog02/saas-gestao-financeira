{% extends "base.html" %}
{% load humanize l10n %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ titulo_pagina|default:"Parcelas a Vencer" }}</h2>
    <span class="badge bg-primary fs-6">{{ parcelas.count }} registros</span>
</div>

<div class="card mb-4 bg-light">
    <div class="card-body p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small fw-bold">Buscar</label>
                <input type="text" name="q" class="form-control form-control-sm" 
                       placeholder="Cliente ou Contrato..." 
                       value="{{ request.GET.q }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">Filtrar</button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Vencimento</th>
                <th>Contrato</th>
                <th>Cliente</th>
                <th>Parc.</th>
                <th class="text-end">Valor</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for p in parcelas %}
            <tr>
                <td class="{% if p.vencimento == hoje %}fw-bold text-primary{% endif %}">
                    {{ p.vencimento|date:"d/m/Y" }}
                    {% if p.vencimento == hoje %} <small>(Hoje)</small>{% endif %}
                </td>
                
                <td>
                    <a href="{% url 'emprestimos:contrato_detalhe' p.emprestimo.id %}" class="text-decoration-none fw-bold">
                        {{ p.emprestimo.codigo_contrato }}
                    </a>
                </td>
                
                <td>{{ p.emprestimo.cliente.nome_completo }}</td>
                
                <td>{{ p.numero }}</td>
                
                <td class="text-end fw-bold">
                    R$ {{ p.valor|floatformat:2|localize }}
                </td>
                
                <td class="text-center">
                    <button type="button" 
                            class="btn btn-sm btn-success"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalPagarParcela"
                            data-id="{{ p.id }}"
                            data-numero="{{ p.numero }}"
                            data-vencimento="{{ p.vencimento|date:'d/m/Y' }}"
                            data-valor="{{ p.valor|floatformat:2 }}"
                            data-cliente="{{ p.emprestimo.cliente.nome_completo }}"
                            data-contrato="{{ p.emprestimo.codigo_contrato }}">
                        <i class="bi bi-cash-coin"></i> Receber
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    Nenhuma parcela encontrada com os filtros selecionados.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalPagarParcela" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Confirmar Pagamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      
      <form method="post" id="formPagarParcela" action="">
        {% csrf_token %}
        <div class="modal-body">
          <p class="text-center fs-5 mb-3">Deseja efetuar a baixa desta parcela?</p>
          
          <div class="card bg-light mb-3">
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                <li><strong>Cliente:</strong> <span id="pg_cliente"></span></li>
                <li><strong>Contrato:</strong> <span id="pg_contrato"></span></li>
                <li><strong>Parcela nº:</strong> <span id="pg_numero"></span></li>
                <li><strong>Vencimento:</strong> <span id="pg_vencimento"></span></li>
                <li class="mt-2 fs-5 text-success"><strong>Valor: R$ <span id="pg_valor"></span></strong></li>
              </ul>
            </div>
          </div>

          <div class="mb-3">
            <label for="senha_pagamento" class="form-label fw-bold">Senha de Confirmação</label>
            <input type="password" name="senha" id="senha_pagamento" class="form-control text-center" 
                   placeholder="Digite a senha (1234)" required autocomplete="off">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não, cancelar</button>
          <button type="submit" class="btn btn-success fw-bold">Sim, confirmar pagamento</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modalPagar = document.getElementById('modalPagarParcela');
    if (modalPagar) {
      modalPagar.addEventListener('show.bs.modal', function (event) {
        // Botão que acionou o modal
        var button = event.relatedTarget;
        
        // Extrair info dos atributos data-*
        var id = button.getAttribute('data-id');
        var numero = button.getAttribute('data-numero');
        var vencimento = button.getAttribute('data-vencimento');
        var valor = button.getAttribute('data-valor');
        var cliente = button.getAttribute('data-cliente');
        var contrato = button.getAttribute('data-contrato');

        // Atualizar os textos do modal
        modalPagar.querySelector('#pg_cliente').textContent = cliente;
        modalPagar.querySelector('#pg_contrato').textContent = contrato;
        modalPagar.querySelector('#pg_numero').textContent = numero;
        modalPagar.querySelector('#pg_vencimento').textContent = vencimento;
        modalPagar.querySelector('#pg_valor').textContent = valor;
        
        // Limpar senha
        modalPagar.querySelector('#senha_pagamento').value = '';

        // Atualizar a ACTION do formulário
        var form = modalPagar.querySelector('#formPagarParcela');
        form.action = '/emprestimos/parcela/' + id + '/pagar/';
      });
      
      modalPagar.addEventListener('shown.bs.modal', function () {
        document.getElementById('senha_pagamento').focus();
      });
    }
  });
</script>
{% endblock %}